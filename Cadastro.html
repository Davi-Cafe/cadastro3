<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Cadastro de Veículos</title>

<style>
*{box-sizing:border-box;margin:0;padding:0}
body{
  font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Arial,sans-serif;
  background:linear-gradient(135deg,#667eea,#764ba2);
  min-height:100vh;
  padding:20px;
  display:flex;
  justify-content:center;
}
.container{
  width:100%;
  max-width:700px;
  background:#fff;
  border-radius:20px;
  padding:30px;
  box-shadow:0 20px 60px rgba(0,0,0,.3);
}
.header{text-align:center;margin-bottom:20px}
.tabs{
  display:flex;
  gap:10px;
  margin-bottom:20px;
}
.tabs button{
  flex:1;
  padding:12px;
  border:none;
  border-radius:10px;
  font-weight:600;
  cursor:pointer;
  background:#e5e7eb;
}
.tabs button.active{
  background:#667eea;
  color:#fff;
}
section{display:none}
section.active{display:block}
label{display:block;font-weight:600;margin:10px 0 6px}
input{
  width:100%;
  padding:14px;
  border-radius:12px;
  border:2px solid #e2e8f0;
}
.button-group{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:15px;
  margin-top:25px;
}
button{
  padding:14px;
  border-radius:12px;
  border:none;
  font-weight:600;
  cursor:pointer;
}
.normal{background:#16a34a;color:#fff}
.ofr{background:#dc2626;color:#fff}
.remove{
  background:#dc2626;
  color:#fff;
  padding:6px 10px;
  border-radius:6px;
}
.download{
  background:#16a34a;
  color:#fff;
  padding:10px 14px;
  border-radius:8px;
  margin-bottom:10px;
}
table{
  width:100%;
  border-collapse:collapse;
}
th,td{
  padding:10px;
  border-bottom:1px solid #e5e7eb;
  text-align:center;
}
.toast{
  position:fixed;
  bottom:20px;
  left:50%;
  transform:translateX(-50%) translateY(100px);
  background:#16a34a;
  color:#fff;
  padding:14px 20px;
  border-radius:10px;
  opacity:0;
  transition:.3s;
}
.toast.show{opacity:1;transform:translateX(-50%)}
.toast.error{background:#dc2626}
</style>
</head>

<body>

<div class="container">
  <div class="header">
    <h2>Cadastro de Veículos</h2>
  </div>

  <div class="tabs">
    <button class="active" onclick="openTab(event,'cadastro')">Cadastro</button>
    <button onclick="openTab(event,'gerenciar')">Gerenciar / Relatório</button>
  </div>

  <!-- CADASTRO (INALTERADO NA LÓGICA) -->
  <section id="cadastro" class="active">
    <label>Transporte</label>
    <input id="transporte" type="number">

    <label>Placa</label>
    <input id="placa" style="text-transform:uppercase">

    <label>Entrada Usina</label>
    <input id="entrada" type="datetime-local">

    <label>Chegada Área</label>
    <input id="chegada" type="datetime-local">

    <div class="button-group">
      <button class="normal" onclick="adicionar(false)">Adicionar Normal</button>
      <button class="ofr" onclick="adicionar(true)">Adicionar OFR</button>
    </div>
  </section>

  <!-- GERENCIAR / RELATÓRIO -->
  <section id="gerenciar">
    <button class="download" onclick="baixarRelatorio()">⬇ Baixar Relatório</button>

    <table>
      <thead>
        <tr>
          <th>Transporte</th>
          <th>Placa</th>
          <th>Chegada</th>
          <th>Entrada</th>
          <th>Tipo</th>
          <th>Ação</th>
        </tr>
      </thead>
      <tbody id="tbodyGerenciar"></tbody>
    </table>
  </section>
</div>

<div id="toast" class="toast"></div>

<script>
const API_URL="/api/fila";
let fila={};

function showToast(msg,err=false){
  const t=document.getElementById("toast");
  t.textContent=msg;
  t.className="toast show"+(err?" error":"");
  setTimeout(()=>t.className="toast",3000);
}

function openTab(e,id){
  document.querySelectorAll("section").forEach(s=>s.classList.remove("active"));
  document.querySelectorAll(".tabs button").forEach(b=>b.classList.remove("active"));
  document.getElementById(id).classList.add("active");
  e.target.classList.add("active");
  if(id==="gerenciar") carregar();
}

async function adicionar(ofr){
  const transporte=transporteInput.value;
  const placa=placaInput.value;
  const entrada=entradaInput.value;
  const chegada=chegadaInput.value;

  if(!transporte||!placa||!entrada||!chegada){
    showToast("Preencha todos os campos",true);
    return;
  }

  const res=await fetch(API_URL,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({
      transporte,
      placa:placa.toUpperCase(),
      entrada,
      chegada,
      tipo:ofr?"OFR":"Normal"
    })
  });

  if(!res.ok){
    showToast("Erro ao enviar dados",true);
    return;
  }

  showToast("Veículo cadastrado com sucesso!");
  transporteInput.value=placaInput.value="";
}

async function carregar(){
  const res=await fetch(API_URL);
  fila=await res.json();
  const tbody=document.getElementById("tbodyGerenciar");
  tbody.innerHTML="";
  Object.entries(fila).forEach(([id,v])=>{
    tbody.innerHTML+=`
      <tr>
        <td>${v.transporte}</td>
        <td>${v.placa}</td>
        <td>${new Date(v.chegada).toLocaleString()}</td>
        <td>${new Date(v.entrada).toLocaleString()}</td>
        <td>${v.tipo}</td>
        <td><button class="remove" onclick="remover('${id}')">Remover</button></td>
      </tr>`;
  });
}

async function remover(id){
  if(!confirm("Retirar veículo da área?")) return;
  await fetch(API_URL+"/"+id,{method:"DELETE"});
  carregar();
}

function baixarRelatorio(){
  const linhas=[["Transporte","Placa","Chegada","Entrada","Tipo"]];
  Object.values(fila).forEach(v=>{
    linhas.push([v.transporte,v.placa,v.chegada,v.entrada,v.tipo]);
  });
  const csv=linhas.map(l=>l.join(";")).join("\n");
  const a=document.createElement("a");
  a.href=URL.createObjectURL(new Blob([csv],{type:"text/csv"}));
  a.download="relatorio_veiculos.csv";
  a.click();
}

/* atalhos */
const transporteInput=document.getElementById("transporte");
const placaInput=document.getElementById("placa");
const entradaInput=document.getElementById("entrada");
const chegadaInput=document.getElementById("chegada");

/* data/hora padrão */
window.addEventListener("DOMContentLoaded",()=>{
  const n=new Date();
  n.setMinutes(n.getMinutes()-n.getTimezoneOffset());
  const v=n.toISOString().slice(0,16);
  entradaInput.value=chegadaInput.value=v;
});
</script>

</body>
</html>
